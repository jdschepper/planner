<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner - ICS Generator</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="planner.html" class="nav-link active">ğŸ“… Planner</a>
            <a href="editor.html" class="nav-link">ğŸ“ Editor</a>
            <a href="handleiding.html" class="nav-link">ğŸ“š Handleiding</a>
        </div>
    </nav>
    
    <div class="content-wrapper">
        <div class="container">
            <h1>ğŸ“… Planner</h1>
            <p class="subtitle">Genereer een ICS bestand op basis van een gekozen datum</p>
        
        <div class="form-group">
            <label for="dataFile">Selecteer json bestand:</label>
            <input type="file" id="dataFile" accept=".json,application/json" required>
        </div>
        
        <div class="form-group">
            <label for="targetDate">Kies de startdatum van het evenement:</label>
            <input type="date" id="targetDate" required>
        </div>
        
        <button id="generateBtn">Genereer ICS Bestand</button>
        
        <div id="info" class="info"></div>
        <div id="eventList" class="event-list"></div>
    </div>

    <script>
        const fileInput = document.getElementById('dataFile');
        const dateInput = document.getElementById('targetDate');
        const generateBtn = document.getElementById('generateBtn');
        const infoDiv = document.getElementById('info');
        const eventListDiv = document.getElementById('eventList');
        
        // Set default date to today
        dateInput.valueAsDate = new Date();
        
        // Function to format date to YYYYMMDD
        function formatDateToICS(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }
        
        // Function to format datetime to ICS format (YYYYMMDDTHHMMSS)
        function formatDateTimeToICS(date, time) {
            const dateStr = formatDateToICS(date);
            const timeParts = time.split(':');
            const hours = timeParts[0].padStart(2, '0');
            const minutes = timeParts[1].padStart(2, '0');
            return `${dateStr}T${hours}${minutes}00`;
        }
        
        // Function to escape ICS text
        function escapeICSText(text) {
            return text.replace(/\\/g, '\\\\')
                      .replace(/;/g, '\\;')
                      .replace(/,/g, '\\,')
                      .replace(/\n/g, '\\n');
        }
        
        // Function to show info message
        function showInfo(message, type = 'success') {
            infoDiv.textContent = message;
            infoDiv.className = `info show ${type}`;
            setTimeout(() => {
                infoDiv.className = 'info';
            }, 5000);
        }
        
        // Function to display events preview
        function displayEvents(events, targetDate) {
            eventListDiv.innerHTML = '<h3 style="margin-bottom: 10px; color: #333; font-size: 16px;">Gebeurtenissen:</h3>';
            
            events.forEach(event => {
                const eventDate = new Date(targetDate);
                eventDate.setDate(eventDate.getDate() - event.dagen_op_voorhand);
                
                const eventDiv = document.createElement('div');
                eventDiv.className = 'event-item';
                
                const timeInfo = event.start_uur && event.eind_uur 
                    ? `${event.start_uur} - ${event.eind_uur}`
                    : 'Hele dag';
                
                const dateStr = eventDate.toLocaleDateString('nl-NL', { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                const description = event.beschrijving ? `<br><small style="color: #888;">${escapeICSText(event.beschrijving).replace(/\\n/g, '<br/>')}</small>` : '';
                
                eventDiv.innerHTML = `
                    <strong>${escapeICSText(event.activiteit_naam)}</strong>
                    <small>${dateStr} â€¢ ${timeInfo}</small>${description}
                `;
                
                eventListDiv.appendChild(eventDiv);
            });
        }
        
        // Function to generate ICS file
        async function generateICS() {
            const targetDateValue = dateInput.value;
            const file = fileInput.files[0];
            
            if (!file) {
                showInfo('Selecteer eerst een JSON bestand!', 'error');
                return;
            }
            
            if (!targetDateValue) {
                showInfo('Selecteer eerst een datum!', 'error');
                return;
            }
            
            try {
                // Read the selected file
                const fileContent = await file.text();
                const jsonData = JSON.parse(fileContent);
                const targetDate = new Date(targetDateValue + 'T00:00:00');
                
                // Check if data has config_name property (new format)
                let data, configName;
                if (jsonData.config_name !== undefined && Array.isArray(jsonData.events)) {
                    configName = jsonData.config_name;
                    data = jsonData.events;
                } else {
                    // Old format - just array of events
                    data = jsonData;
                    // Extract filename without extension as config name
                    configName = file.name.replace(/\.json$/i, '');
                }
                
                // Display events preview
                displayEvents(data, targetDate);
                
                // Generate ICS content
                let icsContent = 'BEGIN:VCALENDAR\r\n';
                icsContent += 'VERSION:2.0\r\n';
                icsContent += 'PRODID:-//Planner//Event Generator//NL\r\n';
                icsContent += 'CALSCALE:GREGORIAN\r\n';
                icsContent += 'METHOD:PUBLISH\r\n';
                
                data.forEach((event, index) => {
                    // Calculate event date (target date minus days before)
                    const eventDate = new Date(targetDate);
                    eventDate.setDate(eventDate.getDate() - event.dagen_op_voorhand);
                    
                    // Check if it's an all-day event
                    const isAllDay = !event.start_uur || !event.eind_uur;
                    
                    icsContent += 'BEGIN:VEVENT\r\n';
                    icsContent += `UID:${Date.now()}-${index}@planner\r\n`;
                    icsContent += `DTSTAMP:${formatDateTimeToICS(new Date(), '00:00')}\r\n`;
                    
                    if (isAllDay) {
                        // All-day event
                        icsContent += `DTSTART;VALUE=DATE:${formatDateToICS(eventDate)}\r\n`;
                        const endDate = new Date(eventDate);
                        endDate.setDate(endDate.getDate() + 1);
                        icsContent += `DTEND;VALUE=DATE:${formatDateToICS(endDate)}\r\n`;
                    } else {
                        // Timed event
                        icsContent += `DTSTART:${formatDateTimeToICS(eventDate, event.start_uur)}\r\n`;
                        icsContent += `DTEND:${formatDateTimeToICS(eventDate, event.eind_uur)}\r\n`;
                    }
                    
                    icsContent += `SUMMARY:${escapeICSText(event.activiteit_naam)}\r\n`;
                    
                    // Add description if present
                    if (event.beschrijving) {
                        icsContent += `DESCRIPTION:${escapeICSText(event.beschrijving)}\r\n`;
                    }
                    
                    icsContent += 'END:VEVENT\r\n';
                });
                
                icsContent += 'END:VCALENDAR\r\n';
                
                // Create and download the file
                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                
                // Use config name as prefix for ICS file
                const safeConfigName = configName.replace(/[^a-z0-9_\-]/gi, '_').toLowerCase();
                link.download = `${safeConfigName}_${formatDateToICS(targetDate)}.ics`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                showInfo(`ICS bestand gegenereerd met ${data.length} gebeurtenis(sen)!`, 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showInfo(`Fout: ${error.message}`, 'error');
            }
        }
        
        // Event listeners
        generateBtn.addEventListener('click', generateICS);
        
        dateInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                generateICS();
            }
        });
    </script>
    </div>
</body>
</html>
